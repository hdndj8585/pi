<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pi Network é’±åŒ… - å¤šèµ„äº§æ”¯æŒ (æœ¬åœ°æ¨¡å¼)</title>
<style>
* { box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
.container { max-width: 800px; width: 100%; background: #fff; padding: 20px; margin: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); border-radius: 15px; position: relative; }
h1, h2, h3 { text-align: center; color: #333; }
label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 12px; margin: 8px 0 16px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
input:focus, textarea:focus, select:focus { border-color: #6a1b9a; outline: none; }
button { padding: 12px; background: linear-gradient(135deg, #6a1b9a, #8e24aa); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s; }
button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(106, 27, 154, 0.4); }
button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.disabled-btn { opacity: 0.5; cursor: not-allowed; background: #ccc !important; }
.message { text-align: center; margin: 20px 0; padding: 15px; border-radius: 8px; font-size: 1.1em; }
.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.log { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; max-height: 400px; overflow-y: auto; }
.wallet-info { text-align: left; }
.balance { font-size: 2em; margin: 20px 0; text-align: center; color: #28a745; font-weight: bold; }
.transaction { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 12px 0; align-items: center; }
.transaction:last-child { border-bottom: none; }
.transaction p { margin: 0; }
.history, .migrations { margin-top: 20px; }
.tab { display: inline-block; padding: 12px 24px; cursor: pointer; border-radius: 8px 8px 0 0; margin-right: 5px; }
.tab.active { font-weight: bold; background-color: #6a1b9a; color: white; }
#loading { display: none; font-size: 1.5em; color: #555; text-align: center; margin: 20px 0; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); }
.short-address { cursor: pointer; text-decoration: underline; color: #007bff; }
#qrcode-container { display: none; margin: 20px 0; text-align: center; }
.assets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
.asset-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); position: relative; }
.asset-card.native { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.asset-card.lp { background: linear-gradient(135deg, #28a745, #20c997); }
.asset-card .asset-name { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
.asset-card .asset-balance { font-size: 1.4em; font-weight: bold; }
.asset-card .asset-issuer { font-size: 0.8em; opacity: 0.8; margin-top: 5px; word-break: break-all; }
.asset-card .asset-actions { margin-top: 10px; display: flex; gap: 5px; }
.asset-card .asset-actions button { flex: 1; padding: 6px 10px; font-size: 0.8em; }
.delete-btn { background: linear-gradient(135deg, #e74c3c, #c0392b) !important; }
.reverse-swap-btn { background: linear-gradient(135deg, #ff8c00, #ff4500) !important; }
.zero-balance { opacity: 0.7; filter: grayscale(0.3); }
.wallet-header { background: linear-gradient(135deg, #6a1b9a, #8e24aa); color: white; padding: 20px; text-align: center; border-radius: 12px 12px 0 0; margin-bottom: 20px; position: relative; }
.wallet-header .title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
.wallet-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
.wallet-actions button { margin: 0; width: 100%; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background-color: #fff; padding: 25px; width: 90%; max-width: 500px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); max-height: 90vh; overflow-y: auto; }
.modal-content h2 { margin-top: 0; color: #6a1b9a; }
.modal-buttons { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; }
.modal-buttons button { flex: 1; margin: 0; }
#confirm-transfer-btn { background: linear-gradient(135deg, #28a745, #20c997); }
#cancel-transfer-btn { background: linear-gradient(135deg, #6c757d, #adb5bd); }
.form-note { font-size: 0.9em; color: #666; margin-top: -10px; margin-bottom: 15px; }
.form-note.warning { color: #e74c3c; font-weight: bold; }
.transaction-status { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
.status-incoming { background-color: #d4edda; color: #155724; }
.status-outgoing { background-color: #f8d7da; color: #721c24; }
.status-trust { background-color: #d1ecf1; color: #0c5460; }
.status-lp-deposit { background-color: #d4edda; color: #155724; }
.status-lp-withdraw { background-color: #f8d7da; color: #721c24; }
@media (max-width: 768px) { .container { margin: 10px; padding: 15px; } .assets-grid { grid-template-columns: 1fr; } .wallet-actions { grid-template-columns: 1fr; } .modal-content { width: 95%; padding: 20px; } }
.copy-btn { padding: 2px 6px; font-size: 0.7em; margin-left: 5px; }
.network-status { position: absolute; top: 10px; right: 10px; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; }
.online { background: #d4edda; color: #155724; }
.offline { background: #f8d7da; color: #721c24; }
.network-select { background: linear-gradient(135deg, #28a745, #20c997); }
.network-select.warning { background: linear-gradient(135deg, #dc3545, #c82333); }
#logout-btn { position: absolute; top: 10px; left: 10px; padding: 5px 10px; font-size: 0.8em; background: linear-gradient(135deg, #dc3545, #c82333); }
</style>
<script src="libs/deps.min.js"></script>
<script src="qrcode.min.js"></script>
<script src="stellar-sdk.min.js"></script>
</head>
<body>
<div class="container">
  <h1>ğŸŒŒ Pi Network å¤šèµ„äº§é’±åŒ… (æœ¬åœ°æ¨¡å¼)</h1>
  <form id="login-form">
    <h2>ç™»å½•é’±åŒ…</h2>
    <label for="network-select">ğŸŒ é€‰æ‹©ç½‘ç»œ</label>
    <select id="network-select">
      <option value="testnet">æµ‹è¯•ç½‘ (æ¨è)</option>
      <option value="mainnet">ä¸»ç½‘ (é£é™©è‡ªè´Ÿ)</option>
    </select>
    <div class="form-note warning">âš ï¸ ä¸»ç½‘ä½¿ç”¨å¯èƒ½æœ‰é£é™©ï¼Œè¯·ç¡®ä¿ä½¿ç”¨æ–°åˆ›å»ºçš„æµ‹è¯•é’±åŒ…ã€‚æµ‹è¯•ç½‘æ›´å®‰å…¨ã€‚</div>
    <label for="mnemonic">åŠ©è®°è¯</label>
    <textarea id="mnemonic" placeholder="è¯·è¾“å…¥æ‚¨çš„24ä¸ªå•è¯åŠ©è®°è¯" rows="3"></textarea>
    <button type="submit">ğŸ”‘ ç™»å½•é’±åŒ…</button>
    <button type="button" id="create-wallet-btn" style="background: linear-gradient(135deg, #28a745, #20c997); margin-top: 10px;" data-i18n="create_wallet">ğŸ†• åˆ›å»ºæ–°é’±åŒ…</button>
    <button type="button" id="clear-cache-btn" style="background: linear-gradient(135deg, #6c757d, #adb5bd); margin-top: 10px;">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
  </form>
  <div id="wallet-info" style="display: none;">
    <div class="wallet-header">
      <div class="title">æˆ‘çš„é’±åŒ…</div>
      <div id="network-status" class="network-status online">ğŸŸ¢ åœ¨çº¿</div>
      <button id="logout-btn">ğŸšª æ³¨é”€</button>
      <p id="public-key"></p>
    </div>
    <button id="show-qrcode-btn">ğŸ“± æ˜¾ç¤ºæ”¶æ¬¾äºŒç»´ç </button>
    <div id="qrcode-container">
      <div id="qrcode"></div>
    </div>
    <h3>ğŸ“Š èµ„äº§åˆ—è¡¨</h3>
    <div id="assets-container" class="assets-grid"></div>
    <div class="wallet-actions">
      <button id="show-transfer-modal-btn">ğŸ’¸ è½¬è´¦</button>
      <button id="create-asset-btn">ğŸ†• åˆ›å»ºèµ„äº§</button>
      <button id="trust-asset-btn">ğŸ¤ ä¿¡ä»»èµ„äº§</button>
      <button id="create-lp-btn">ğŸ’§ åˆ›å»ºæµåŠ¨æ± </button>
      <button id="refresh-assets-btn">ğŸ”„ åˆ·æ–°èµ„äº§</button>
      <button id="export-mnemonic-btn">ğŸ“¤ å¯¼å‡ºåŠ©è®°è¯</button>
    </div>
    <div class="wallet-history">
      <div class="tabs">
        <button class="active tab" data-tab="history">ğŸ“œ äº¤æ˜“å†å²</button>
        <button class="tab" data-tab="assets">ğŸ’ èµ„äº§ç®¡ç†</button>
        <button class="tab" data-tab="dex">ğŸ”„ DEX å…‘æ¢</button>
      </div>
      <div id="history" class="history">
        <h3>äº¤æ˜“è®°å½• <button id="refresh-btn">ğŸ”„ åˆ·æ–°</button><button id="prev-history">ä¸Šä¸€é¡µ</button><button id="next-history">ä¸‹ä¸€é¡µ</button></h3>
        <div id="transaction-log" class="log"></div>
      </div>
      <div id="assets" class="migrations" style="display: none;">
        <h3>æˆ‘çš„èµ„äº§</h3>
        <div id="assets-details" class="log"></div>
      </div>
      <div id="dex" class="migrations" style="display: none;">
        <h3>DEX èµ„äº§åˆ—è¡¨ <button id="add-dex-asset-btn">+ æ·»åŠ DEXèµ„äº§</button></h3>
        <div id="dex-assets" class="assets-grid"></div>
      </div>
      <div id="market" class="migrations" style="display: none;">
        <h3>å¸‚åœº - å·²å‘å¸ƒèµ„äº§</h3>
        <p>ä»¥ä¸‹æ˜¯å·²å‘å¸ƒçš„èµ„äº§åˆ—è¡¨ï¼ˆç”±ç®¡ç†å‘˜æ·»åŠ ï¼‰ã€‚ç‚¹å‡»é“¾æ¥æŸ¥çœ‹è¯¦æƒ…ã€‚</p>
        <div class="assets-grid">
          <div class="asset-card">
            <div class="asset-name">ç¤ºä¾‹èµ„äº§1: TOKENA</div>
            <div class="asset-issuer">å‘è¡Œè€…: GABC...DEF</div>
            <div class="asset-actions">
              <a href="https://example.com/asset/tokena" target="_blank"><button>æŸ¥çœ‹è¯¦æƒ…</button></a>
              <button onclick="trustMarketAsset('TOKENA', 'GABCDEF...')">ä¿¡ä»»</button>
            </div>
          </div>
          <div class="asset-card">
            <div class="asset-name">ç¤ºä¾‹èµ„äº§2: TOKENB</div>
            <div class="asset-issuer">å‘è¡Œè€…: GXYZ...ABC</div>
            <div class="asset-actions">
              <a href="https://example.com/asset/tokenb" target="_blank"><button>æŸ¥çœ‹è¯¦æƒ…</button></a>
              <button onclick="trustMarketAsset('TOKENB', 'GXYZABC...')">ä¿¡ä»»</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="message" class="message"></div>
  <div id="loading">â³ åŠ è½½ä¸­...</div>
</div>
<div id="transfer-modal" class="modal">
  <div class="modal-content">
    <h2>ğŸ’¸ è½¬è´¦</h2>
    <label for="asset-select">é€‰æ‹©è½¬è´¦èµ„äº§</label>
    <select id="asset-select"><option value="native">Pi (åŸç”Ÿèµ„äº§)</option></select>
    <label for="modal-des_addr">ğŸ¯ ç›®æ ‡åœ°å€</label>
    <input type="text" id="modal-des_addr" placeholder="è¾“å…¥æ¥æ”¶æ–¹åœ°å€" />
    <label for="modal-amount">ğŸ’° è½¬è´¦é‡‘é¢</label>
    <input type="number" id="modal-amount" placeholder="è¾“å…¥é‡‘é¢" step="0.0000001" min="0" />
    <label for="modal-memo">ğŸ“ å¤‡æ³¨ (å¯é€‰)</label>
    <input type="text" id="modal-memo" placeholder="è½¬è´¦è¯´æ˜" />
    <div class="modal-buttons">
      <button id="confirm-transfer-btn">âœ… ç¡®è®¤è½¬è´¦</button>
      <button id="cancel-transfer-btn">âŒ å–æ¶ˆ</button>
    </div>
  </div>
</div>
<div id="create-modal" class="modal">
  <div class="modal-content">
    <h2>ğŸ†• åˆ›å»ºèµ„äº§</h2>
    <label for="create-asset-code">èµ„äº§ä»£ç  (1-12å­—ç¬¦ï¼Œè‡ªåŠ¨è½¬ä¸ºå¤§å†™)</label>
    <input type="text" id="create-asset-code" placeholder="ä¾‹å¦‚: MYTOKEN" maxlength="12" />
    <label for="create-initial-supply">åˆå§‹å‘è¡Œé‡</label>
    <input type="number" id="create-initial-supply" placeholder="1000000" step="0.0000001" min="0" />
    <label for="create-destination">ğŸ¯ æ¥æ”¶åœ°å€ (å¯é€‰)</label>
    <input type="text" id="create-destination" placeholder="ç•™ç©ºåˆ™å‘é€ç»™è‡ªå·±" />
    <div class="form-note">ğŸ’¡ æç¤ºï¼šå¦‚æœå‘é€ç»™å…¶ä»–åœ°å€ï¼Œè¯·ç¡®ä¿å¯¹æ–¹å·²ä¿¡ä»»è¯¥èµ„äº§</div>
    <div class="form-note warning">âš ï¸ é‡è¦ï¼šç®€åŒ–åˆ›å»ºæµç¨‹ï¼Œåªæ‰§è¡ŒåŸºæœ¬æ”¯ä»˜æ“ä½œ</div>
    <div class="modal-buttons">
      <button id="confirm-create-btn">âœ… åˆ›å»ºèµ„äº§</button>
      <button id="cancel-create-btn">âŒ å–æ¶ˆ</button>
    </div>
  </div>
</div>
<div id="trust-modal" class="modal">
  <div class="modal-content">
    <h2>ğŸ¤ ä¿¡ä»»èµ„äº§</h2>
    <label for="trust-asset-code">èµ„äº§ä»£ç </label>
    <input type="text" id="trust-asset-code" placeholder="ä¾‹å¦‚: USD" />
    <label for="trust-asset-issuer">å‘è¡Œè€…åœ°å€</label>
    <input type="text" id="trust-asset-issuer" placeholder="å‘è¡Œè€…å…¬é’¥" />
    <label for="trust-limit">ä¿¡ä»»é™é¢ (å¯é€‰ï¼Œé»˜è®¤æ— é™)</label>
    <input type="text" id="trust-limit" placeholder="ä¾‹å¦‚: 1000" />
    <div class="form-note">ğŸ’¡ æç¤ºï¼šä¿¡ä»»èµ„äº§åæ‰èƒ½æ¥æ”¶è¯¥èµ„äº§çš„è½¬è´¦</div>
    <div class="modal-buttons">
      <button id="confirm-trust-btn">âœ… ä¿¡ä»»èµ„äº§</button>
      <button id="cancel-trust-btn">âŒ å–æ¶ˆ</button>
    </div>
  </div>
</div>
<div id="lp-modal" class="modal">
  <div class="modal-content">
    <h2>ğŸ’§ åˆ›å»ºæµåŠ¨æ± </h2>
    <p>èµ„äº§ A: Pi (åŸç”Ÿ) | èµ„äº§ B: è‡ªå®šä¹‰èµ„äº§</p>
    <label for="lp-asset-b-code">èµ„äº§ B ä»£ç </label>
    <input type="text" id="lp-asset-b-code" placeholder="ä¾‹å¦‚: BNB" maxlength="12" />
    <label for="lp-asset-b-issuer">èµ„äº§ B å‘è¡Œè€…åœ°å€</label>
    <input type="text" id="lp-asset-b-issuer" placeholder="å‘è¡Œè€…å…¬é’¥" />
    <label for="lp-amount-a">å­˜å…¥ Pi æ•°é‡</label>
    <input type="number" id="lp-amount-a" placeholder="10" step="0.0000001" min="0" />
    <label for="lp-amount-b">å­˜å…¥ èµ„äº§ B æ•°é‡</label>
    <input type="number" id="lp-amount-b" placeholder="10" step="0.0000001" min="0" />
    <label for="lp-pool-fee">æ± å­æ‰‹ç»­è´¹ (bps, é»˜è®¤30=0.3%)</label>
    <select id="lp-pool-fee">
      <option value="30">0.3%</option>
      <option value="50">0.5%</option>
      <option value="100">1.0%</option>
      <option value="500">5.0%</option>
    </select>
    <div class="form-note">ğŸ’¡ æç¤ºï¼šç¡®ä¿å·²ä¿¡ä»»èµ„äº§ Bï¼Œå¹¶æœ‰è¶³å¤Ÿä½™é¢</div>
    <div class="form-note warning">âš ï¸ æ³¨æ„ï¼šåˆ›å»ºæ± å­ä¼šè‡ªåŠ¨åˆ›å»º LP ä»½é¢ä¿¡ä»»çº¿</div>
    <div class="modal-buttons">
      <button id="confirm-lp-btn">âœ… åˆ›å»ºæµåŠ¨æ± </button>
      <button id="cancel-lp-btn">âŒ å–æ¶ˆ</button>
    </div>
  </div>
</div>
<div id="delete-modal" class="modal">
  <div class="modal-content">
    <h2>ğŸ—‘ï¸ åˆ é™¤èµ„äº§</h2>
    <p id="delete-asset-info">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèµ„äº§å—ï¼Ÿ</p>
    <div class="form-note warning">âš ï¸ æ³¨æ„ï¼šåˆ é™¤èµ„äº§éœ€è¦å…ˆå°†ä½™é¢è½¬å‡ºä¸º0ã€‚æ­¤æ“ä½œä¸å¯é€†ï¼</div>
    <div class="modal-buttons">
      <button id="confirm-delete-btn">âœ… ç¡®è®¤åˆ é™¤</button>
      <button id="cancel-delete-btn">âŒ å–æ¶ˆ</button>
    </div>
  </div>
</div>
<div id="export-modal" class="modal">
  <div class="modal-content">
    <h2>ğŸ“¤ å¯¼å‡ºåŠ©è®°è¯</h2>
    <p class="form-note warning">âš ï¸ è­¦å‘Šï¼šè¯·å‹¿å°†åŠ©è®°è¯åˆ†äº«ç»™ä»»ä½•äººï¼ä¸¢å¤±åŠ©è®°è¯å°†å¯¼è‡´èµ„äº§æ°¸ä¹…ä¸¢å¤±ã€‚</p>
    <textarea id="export-mnemonic-text" rows="4" readonly></textarea>
    <div class="modal-buttons">
      <button id="copy-mnemonic-btn">ğŸ“‹ å¤åˆ¶</button>
      <button id="close-export-btn">âŒ å…³é—­</button>
    </div>
  </div>
</div>
<div id="swap-modal" class="modal">
  <div class="modal-content">
    <h2>ğŸ”„ DEX å…‘æ¢</h2>
    <p>ä» <span id="swap-source-asset">Pi</span> å…‘æ¢åˆ° <span id="swap-target-asset"></span></p>
    <label for="swap-source-amount">è¾“å…¥ <span id="swap-source-asset-label">Pi</span> æ•°é‡</label>
    <input type="number" id="swap-source-amount" placeholder="è¾“å…¥æ•°é‡" step="0.0000001" min="0" />
    <label for="slippage-select">å®¹å¿åº¦ (%)</label>
    <select id="slippage-select">
      <option value="1">1%</option>
      <option value="5">5%</option>
      <option value="10">10%</option>
      <option value="25">25%</option>
      <option value="50">50%</option>
      <option value="75">75%</option>
      <option value="90">90%</option>
    </select>
    <p>é¢„è®¡æ¥æ”¶: <span id="swap-estimate-amount">0</span></p>
    <div class="form-note">ğŸ’¡ æç¤ºï¼šæ»‘ç‚¹è®¾ç½®è¶Šé«˜ï¼Œåœ¨æµåŠ¨æ€§ä¸è¶³æ—¶äº¤æ˜“æˆåŠŸç‡è¶Šé«˜ï¼Œä½†å¯èƒ½æŸå¤±æ›´å¤šä»·å€¼</div>
    <div class="modal-buttons">
      <button id="get-quote-btn">ğŸ“Š è·å–æŠ¥ä»·</button>
      <button id="confirm-swap-btn">âœ… ç¡®è®¤å…‘æ¢</button>
      <button id="cancel-swap-btn">âŒ å–æ¶ˆ</button>
    </div>
  </div>
</div>
<div id="disclaimer-modal" class="modal" style="display: flex;">
  <div class="modal-content">
    <h2>âš ï¸ è­¦å‘Šå…è´£è¯´æ˜</h2>
    <p style="line-height: 1.5; margin-bottom: 20px;">å¼€æºæµ‹è¯•ç‰ˆæœ¬ï¼Œç»ä¸å…è®¸ä½¿ç”¨ä»»ä½•å…³è”è¿‡Piä¸»ç½‘çš„é’±åŒ…ï¼Œè®¾ç½®è¿‡Piappä¸»ç½‘æ¸…å•é’±åŒ…ç¦æ­¢ä½¿ç”¨ï¼Œå¦åˆ™å‡ºç°è¢«ç›—åæœè‡ªè´Ÿã€‚<br><br><strong>åªå…è®¸ä½¿ç”¨æ–°åˆ›å»ºçš„æµ‹è¯•ç½‘é’±åŒ…ã€‚</strong><br><br>åŒæ„ä»¥ä¸Šå†…å®¹å¯ä»¥ç»§ç»­ä½“éªŒã€‚ä¸åŒæ„é€€å‡ºã€‚</p>
    <div class="modal-buttons">
      <button id="agree-btn" style="background: linear-gradient(135deg, #28a745, #20c997);">âœ… åŒæ„å¹¶ç»§ç»­</button>
      <button id="disagree-btn" style="background: linear-gradient(135deg, #dc3545, #c82333);">âŒ ä¸åŒæ„å¹¶é€€å‡º</button>
    </div>
  </div>
</div>
<script>
let HORIZON_URL, NETWORK_PASSPHRASE, server, mnemonic, publicKey, keypair, currentBalances = [], currentAssets = [], assetToDelete = null, swapTarget = { code: '', issuer: '' }, swapSource = { code: 'native', issuer: '' }, isReverseSwap = false, historyCollection = null, isOfflineMode = false;

function setNetwork(isTestnet) {
  if (isTestnet) { HORIZON_URL = "https://api.testnet.minepi.com"; NETWORK_PASSPHRASE = "Pi Testnet"; } else { HORIZON_URL = "https://api.mainnet.minepi.com"; NETWORK_PASSPHRASE = "Pi Network"; }
  server = new StellarSdk.Server(HORIZON_URL);
}

function toggleLoading(show) { document.getElementById("loading").style.display = show ? "block" : "none"; }

function showMessage(message, type = 'info') {
  const messageDiv = document.getElementById("message");
  messageDiv.textContent = message; messageDiv.className = `message ${type}`; messageDiv.style.display = 'block';
  setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
}

function copyToClipboard(text) {
  if (navigator.clipboard) { navigator.clipboard.writeText(text).then(() => showMessage("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", 'success')).catch(fallbackCopy(text)); } else { fallbackCopy(text); }
}

function fallbackCopy(text) {
  const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select();
  try { const successful = document.execCommand('copy'); showMessage(successful ? "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿" : "å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶: " + text, successful ? 'success' : 'error'); } catch (err) { showMessage("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶: " + text, 'error'); }
  document.body.removeChild(textArea);
}

function updateNetworkStatus(online) {
  const statusEl = document.getElementById("network-status");
  if (online) { statusEl.textContent = 'ğŸŸ¢ åœ¨çº¿'; statusEl.className = 'network-status online'; isOfflineMode = false; } else { statusEl.textContent = 'ğŸ”´ ç¦»çº¿'; statusEl.className = 'network-status offline'; isOfflineMode = true; }
}

async function checkNetwork(autoRefresh = false) {
  if (!navigator.onLine) { updateNetworkStatus(false); if (autoRefresh && keypair) loadCachedAssets(); return false; }
  try { await fetch(HORIZON_URL + '/info', { method: 'HEAD', mode: 'no-cors' }); updateNetworkStatus(true); if (autoRefresh && keypair) await refreshAccountData(); return true; } catch (e) { updateNetworkStatus(false); if (autoRefresh && keypair) loadCachedAssets(); return false; }
}

async function generateKeypairFromMnemonic(phrase) {
  if (!bip39.validateMnemonic(phrase)) throw new Error("æ— æ•ˆçš„åŠ©è®°è¯");
  const seed = bip39.mnemonicToSeedSync(phrase); const derived = ed25519.derivePath("m/44'/314159'/0'", seed); return StellarSdk.Keypair.fromRawEd25519Seed(derived.key);
}

async function loadAccountSafely(pubKey) {
  if (!navigator.onLine) throw new Error("ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åŠ è½½è´¦æˆ·æ•°æ®");
  try { const result = await server.loadAccount(pubKey); updateNetworkStatus(true); return result; } catch (e) {
    if (e.name === 'NotFoundError') { updateNetworkStatus(true); throw new Error("è´¦æˆ·ä¸å­˜åœ¨ï¼ˆå¯èƒ½æ˜¯æ–°é’±åŒ…ï¼‰"); } else { updateNetworkStatus(false); throw new Error("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"); }
  }
}

async function loadKeypairAndAccount(phrase) {
  if (!bip39.validateMnemonic(phrase)) throw new Error("æ— æ•ˆçš„åŠ©è®°è¯");
  const seed = bip39.mnemonicToSeedSync(phrase); const derived = ed25519.derivePath("m/44'/314159'/0'", seed); const kp = StellarSdk.Keypair.fromRawEd25519Seed(derived.key);
  try { const account = await loadAccountSafely(kp.publicKey()); return { keypair: kp, account }; } catch (e) { if (e.message.includes("è´¦æˆ·ä¸å­˜åœ¨") || e.message.includes("ç½‘ç»œè¿æ¥å¤±è´¥") || e.message.includes("ç¦»çº¿æ¨¡å¼")) return { keypair: kp, account: null }; throw e; }
}

async function processTransactions(transactions, public_key) {
  const transaction_records = [];
  for (const tx of transactions.records) {
    try {
      const operations = await server.operations().forTransaction(tx.id).call();
      for (const op of operations.records) {
        const record = { id: tx.id, created_at: tx.created_at, memo: tx.memo || "", successful: tx.successful !== false };
        if (op.type === "payment") {
          record.type = "payment"; record.amount = op.amount; record.asset_type = op.asset_type; record.asset_code = op.asset_code || ""; record.asset_issuer = op.asset_issuer || ""; record.from = op.from || ""; record.to = op.to || "";
          if (record.from === public_key) { record.direction = "outgoing"; record.counterparty = record.to; } else { record.direction = "incoming"; record.counterparty = record.from; }
        } else if (op.type === "change_trust") { record.type = "change_trust"; record.asset_code = op.asset_code || ""; record.asset_issuer = op.asset_issuer || ""; record.limit = op.limit === "922337203685.4775807" ? "unlimited" : op.limit; record.direction = "trust"; }
        else if (op.type === "create_account") { record.type = "create_account"; record.funder = op.funder || ""; record.account = op.account || ""; record.starting_balance = op.starting_balance || ""; }
        else if (op.type === "path_payment_strict_send") { record.type = "path_payment_strict_send"; record.source_amount = op.source_amount || ""; record.source_asset_code = op.source_asset_code || ""; record.source_asset_issuer = op.source_asset_issuer || ""; record.amount = op.amount || ""; record.asset_code = op.asset_code || ""; record.asset_issuer = op.asset_issuer || ""; record.direction = "dex_swap"; }
        else if (op.type === "liquidity_pool_deposit") { record.type = "liquidity_pool_deposit"; record.pool_id = op.liquidity_pool_id || ""; record.shares = op.shares || ""; record.direction = "lp_deposit"; }
        else if (op.type === "liquidity_pool_withdraw") { record.type = "liquidity_pool_withdraw"; record.pool_id = op.liquidity_pool_id || ""; record.shares = op.shares || ""; record.direction = "lp_withdraw"; }
        if (record.type) transaction_records.push(record);
      }
    } catch (e) { console.error("å¤„ç†äº¤æ˜“é”™è¯¯:", e); }
  }
  return transaction_records;
}

function getAccountAllAssets(account_data, public_key) {
  const assets = [];
  if (!account_data || !account_data.balances) return assets;
  for (const balance of account_data.balances) {
    const asset_info = { balance: balance.balance, asset_type: balance.asset_type, limit: balance.limit || "0", buying_liabilities: balance.buying_liabilities || "0", selling_liabilities: balance.selling_liabilities || "0" };
    if (balance.asset_type === "native") { asset_info.asset_code = "Pi"; asset_info.asset_issuer = "native"; asset_info.asset_name = "Stellar Lumens"; asset_info.is_native = true; asset_info.is_lp = false; }
    else if (balance.asset_type === "credit_alphanum4" || balance.asset_type === "credit_alphanum12") { asset_info.asset_code = balance.asset_code; asset_info.asset_issuer = balance.asset_issuer; asset_info.asset_name = `${balance.asset_code} Token`; asset_info.is_native = false; asset_info.is_lp = false; }
    else if (balance.asset_type === "liquidity_pool_shares") {
      const lp_id = balance.liquidity_pool_id || "";
      try {
        const lp_data = server.liquidity_pools().liquidity_pool(lp_id).call();
        const reserves = lp_data.reserves;
        const asset_a = reserves[0]?.asset || 'Unknown';
        const asset_b = reserves[1]?.asset || 'Unknown';
        asset_info.asset_code = "LP"; asset_info.asset_issuer = "LP"; asset_info.asset_name = `LP: ${asset_a.split(':')[0]}-${asset_b.split(':')[0]}`; asset_info.is_native = false; asset_info.is_lp = true; asset_info.pool_id = lp_id; asset_info.asset_a = asset_a; asset_info.asset_b = asset_b;
      } catch (e) { asset_info.asset_code = "LP"; asset_info.asset_issuer = "LP"; asset_info.asset_name = `Liquidity Pool (${lp_id.substring(0, 8)}...)`; asset_info.is_native = false; asset_info.is_lp = true; asset_info.pool_id = lp_id; }
    } else { asset_info.asset_code = balance.asset_code || "Unknown"; asset_info.asset_issuer = balance.asset_issuer || "Unknown"; asset_info.asset_name = "Unknown Asset"; asset_info.is_native = false; asset_info.is_lp = false; }
    assets.push(asset_info);
  }
  return assets;
}

function saveAssetsToCache(assets) { localStorage.setItem('cachedAssets', JSON.stringify(assets)); }

function loadCachedAssets() {
  const cached = localStorage.getItem('cachedAssets');
  if (cached) {
    try { currentAssets = JSON.parse(cached); displayAssets(currentAssets); displayDexAssets(currentAssets); showMessage("å·²åŠ è½½ç¼“å­˜èµ„äº§æ•°æ®", 'info'); } catch (e) { console.error("åŠ è½½ç¼“å­˜èµ„äº§å¤±è´¥:", e); displayNoAssets(); }
  } else { displayNoAssets(); }
}

function displayNoAssets() {
  const container = document.getElementById("assets-container"), detailsContainer = document.getElementById("assets-details"), dexContainer = document.getElementById("dex-assets");
  if (container) container.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">æš‚æ— èµ„äº§</p>';
  if (detailsContainer) detailsContainer.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— èµ„äº§</p>';
  if (dexContainer) dexContainer.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">æš‚æ— DEXèµ„äº§ï¼Œè¯·æ·»åŠ ä¿¡ä»»èµ„äº§</p>';
}

function displayAssets(assets) {
  const container = document.getElementById("assets-container"), detailsContainer = document.getElementById("assets-details");
  container.innerHTML = ''; detailsContainer.innerHTML = '';
  if (!assets || assets.length === 0) { container.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">æš‚æ— èµ„äº§</p>'; detailsContainer.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— èµ„äº§</p>'; return; }
  assets.forEach(asset => {
    if (!asset) return;
    const isZeroBalance = parseFloat(asset.balance) === 0; const cardClass = asset.is_native ? 'native' : (asset.is_lp ? 'lp' : '');
    const assetCard = document.createElement("div"); assetCard.className = `asset-card ${cardClass} ${isZeroBalance ? 'zero-balance' : ''}`;
    let actionsHtml = '';
    if (!asset.is_native && !asset.is_lp) { actionsHtml = `<div class="asset-actions"><button onclick="transferAsset('${asset.asset_code}', '${asset.asset_issuer}')">è½¬è´¦</button><button class="reverse-swap-btn" onclick="showReverseSwapModal('${asset.asset_code}', '${asset.asset_issuer}')">å…‘æ¢ä¸ºPi</button><button class="delete-btn" onclick="showDeleteModal('${asset.asset_code}', '${asset.asset_issuer}', ${asset.balance})">åˆ é™¤</button></div>`; }
    else if (asset.is_lp) { actionsHtml = `<div class="asset-actions"><button class="delete-btn" onclick="showDeleteModal('${asset.asset_code}', '${asset.asset_issuer}', ${asset.balance})" disabled>ç§»é™¤LP</button></div>`; } else { actionsHtml = `<div class="asset-actions"><button onclick="transferAsset('${asset.asset_code}', '${asset.asset_issuer}')">è½¬è´¦</button></div>`; }
    let assetName = asset.asset_code || 'æœªçŸ¥èµ„äº§'; if (asset.is_lp) assetName = asset.asset_name || 'LP';
    let lpIdHtml = ''; if (asset.is_lp) { const shortId = (asset.pool_id || 'æœªçŸ¥').substring(0, 8) + '...'; lpIdHtml = `<div class="asset-issuer">æ± å­ ID: ${shortId}<button class="copy-btn" onclick="copyToClipboard('${asset.pool_id}')">å¤åˆ¶</button></div>`; } else if (!asset.is_native) { lpIdHtml = `<div class="asset-issuer">å‘è¡Œè€…: ${(asset.asset_issuer || '').substring(0, 8)}...</div>`; }
    assetCard.innerHTML = `<div class="asset-name">${assetName}</div><div class="asset-balance">${parseFloat(asset.balance || 0).toLocaleString()}</div>${isZeroBalance ? '<div style="font-size: 0.7em; opacity: 0.8;">ä½™é¢ä¸º0</div>' : ''}${lpIdHtml}${actionsHtml}`; container.appendChild(assetCard);
    const assetDetail = document.createElement("div"); assetDetail.className = "transaction"; let detailActions = '', detailLpId = '', detailAssetName = asset.asset_code || 'æœªçŸ¥èµ„äº§';
    if (asset.is_lp) { detailAssetName = asset.asset_name || 'LP'; const shortId = (asset.pool_id || 'æœªçŸ¥').substring(0, 8) + '...'; detailLpId = `<br><small>æ± å­ ID: ${shortId} <button class="copy-btn" onclick="copyToClipboard('${asset.pool_id}')">å¤åˆ¶</button></small>`; } else if (!asset.is_native) { detailLpId = `<br><small>å‘è¡Œè€…: ${asset.asset_issuer || 'æœªçŸ¥'}</small>`; }
    if (!asset.is_native && !asset.is_lp) { detailActions = `<div style="margin-top: 5px;"><button onclick="transferAsset('${asset.asset_code}', '${asset.asset_issuer}')" style="padding: 5px 10px; margin-right: 5px;">è½¬è´¦</button><button class="reverse-swap-btn" onclick="showReverseSwapModal('${asset.asset_code}', '${asset.asset_issuer}')" style="padding: 5px 10px; margin-right: 5px;">å…‘æ¢ä¸ºPi</button><button class="delete-btn" onclick="showDeleteModal('${asset.asset_code}', '${asset.asset_issuer}', ${asset.balance})" style="padding: 5px 10px;">åˆ é™¤</button></div>`; }
    else if (asset.is_lp) { detailActions = `<div style="margin-top: 5px;"><button class="delete-btn" style="padding: 5px 10px;" disabled>ç§»é™¤LP</button></div>`; } else { detailActions = `<div style="margin-top: 5px;"><button onclick="transferAsset('${asset.asset_code}', '${asset.asset_issuer}')" style="padding: 5px 10px;">è½¬è´¦</button></div>`; }
    assetDetail.innerHTML = `<div><strong>${detailAssetName}</strong>${isZeroBalance ? '<br><small style="color: #999;">ä½™é¢ä¸º0</small>' : ''}${detailLpId}</div><div><div style="font-weight: bold; color: ${isZeroBalance ? '#999' : '#28a745'};">${asset.balance || 0}</div>${detailActions}</div>`; detailsContainer.appendChild(assetDetail);
  });
  saveAssetsToCache(assets);
}

function displayAssetsOffline() { loadCachedAssets(); }

function displayDexAssets(assets) {
  const container = document.getElementById("dex-assets");
  if (!container) return; container.innerHTML = '';
  if (!assets || assets.length === 0) { container.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">æš‚æ— DEXèµ„äº§ï¼Œè¯·æ·»åŠ ä¿¡ä»»èµ„äº§</p>'; return; }
  assets.forEach(asset => { if (!asset || asset.is_lp) return; const isZeroBalance = parseFloat(asset.balance) === 0; const assetCard = document.createElement("div"); assetCard.className = `asset-card ${asset.is_native ? 'native' : ''} ${isZeroBalance ? 'zero-balance' : ''}`; let actionsHtml = '';
    if (asset.is_native) { actionsHtml = `<div class="asset-actions"><button onclick="showSwapModal('${asset.asset_code}', '${asset.asset_issuer}')">å…‘æ¢å…¶ä»–èµ„äº§</button></div>`; } else { actionsHtml = `<div class="asset-actions"><button onclick="showSwapModal('${asset.asset_code}', '${asset.asset_issuer}')">ç”¨Piå…‘æ¢</button><button class="reverse-swap-btn" onclick="showReverseSwapModal('${asset.asset_code}', '${asset.asset_issuer}')">å…‘æ¢ä¸ºPi</button><button class="delete-btn" onclick="showDeleteModal('${asset.asset_code}', '${asset.asset_issuer}', ${asset.balance})">åˆ é™¤</button></div>`; }
    assetCard.innerHTML = `<div class="asset-name">${asset.asset_code || 'æœªçŸ¥èµ„äº§'}</div><div class="asset-balance">${parseFloat(asset.balance || 0).toLocaleString()}</div>${isZeroBalance ? '<div style="font-size: 0.7em; opacity: 0.8;">ä½™é¢ä¸º0</div>' : ''}${!asset.is_native ? `<div class="asset-issuer">å‘è¡Œè€…: ${(asset.asset_issuer || '').substring(0, 8)}...</div>` : ''}${actionsHtml}`; container.appendChild(assetCard); });
}

function transferAsset(assetCode, assetIssuer) { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•è½¬è´¦ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } const select = document.getElementById("asset-select"); select.innerHTML = '<option value="native">Pi (åŸç”Ÿèµ„äº§)</option>'; const opt = document.createElement("option"); opt.value = `${assetCode}:${assetIssuer}`; opt.text = `${assetCode} (${(assetIssuer || '').substring(0, 8)}...)`; opt.selected = true; select.add(opt); document.getElementById("transfer-modal").style.display = "flex"; }

function showDeleteModal(assetCode, assetIssuer, balance) { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åˆ é™¤èµ„äº§ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } assetToDelete = { assetCode, assetIssuer, balance }; document.getElementById("delete-asset-info").innerHTML = `ç¡®å®šè¦åˆ é™¤èµ„äº§ <strong>${assetCode}</strong> å—ï¼Ÿ<br> å½“å‰ä½™é¢: ${balance}`; document.getElementById("delete-modal").style.display = "flex"; }

function showSwapModal(code, issuer) { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•å…‘æ¢ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } isReverseSwap = false; swapTarget = { code, issuer }; swapSource = { code: 'native', issuer: '' }; document.getElementById("swap-source-asset").textContent = "Pi"; document.getElementById("swap-source-asset-label").textContent = "Pi"; document.getElementById("swap-target-asset").textContent = `${code} (${issuer.substring(0, 8)}...)`; document.getElementById("swap-source-amount").value = ''; document.getElementById("swap-estimate-amount").textContent = '0'; document.getElementById("slippage-select").value = '1'; document.getElementById("swap-modal").style.display = "flex"; }

function showReverseSwapModal(code, issuer) { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•å…‘æ¢ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } isReverseSwap = true; swapSource = { code, issuer }; swapTarget = { code: 'native', issuer: '' }; document.getElementById("swap-source-asset").textContent = `${code} (${issuer.substring(0, 8)}...)`; document.getElementById("swap-source-asset-label").textContent = code; document.getElementById("swap-target-asset").textContent = "Pi"; document.getElementById("swap-source-amount").value = ''; document.getElementById("swap-estimate-amount").textContent = '0'; document.getElementById("slippage-select").value = '1'; document.getElementById("swap-modal").style.display = "flex"; }

function trustMarketAsset(code, issuer) { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•ä¿¡ä»»èµ„äº§ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } document.getElementById("trust-asset-code").value = code; document.getElementById("trust-asset-issuer").value = issuer; document.getElementById("trust-modal").style.display = "flex"; }

function createTransactionElement(tx) {
  const txElem = document.createElement("div"); txElem.className = "transaction"; let statusClass = '', statusText = '', amountText = '', counterpartyText = '';
  const safeSubstring = (str, start, end) => { if (!str) return 'æœªçŸ¥'; return str.substring(start, end) + '...'; };
  if (tx.type === "payment") {
    const asset = tx.asset_code ? `${tx.asset_code}` : 'Pi'; const shortFrom = safeSubstring(tx.from, 0, 6); const shortTo = safeSubstring(tx.to, 0, 6);
    if (tx.direction === "incoming") { statusClass = 'status-incoming'; statusText = 'æ”¶å…¥'; amountText = `+${tx.amount} ${asset}`; counterpartyText = `æ¥è‡ª: ${shortFrom}`; } else { statusClass = 'status-outgoing'; statusText = 'æ”¯å‡º'; amountText = `-${tx.amount} ${asset}`; counterpartyText = `å‘ç»™: ${shortTo}`; }
    txElem.innerHTML = `<div style="flex: 1;"><div style="display: flex; justify-content: space-between; align-items: center;"><span class="transaction-status ${statusClass}">${statusText}</span><strong style="color: ${tx.direction === 'incoming' ? '#28a745' : '#dc3545'}">${amountText}</strong></div><div style="font-size: 0.9em; color: #666; margin-top: 5px;">${counterpartyText}${tx.memo ? ` | å¤‡æ³¨: ${tx.memo}` : ''}</div><div style="font-size: 0.8em; color: #999;">${new Date(tx.created_at).toLocaleString()}</div></div>`;
  } else if (tx.type === "change_trust") {
    const shortIssuer = safeSubstring(tx.asset_issuer, 0, 8);
    txElem.innerHTML = `<div style="flex: 1;"><div style="display: flex; justify-content: space-between; align-items: center;"><span class="transaction-status status-trust">èµ„äº§ä¿¡ä»»</span><strong>${tx.asset_code || 'èµ„äº§'}</strong></div><div style="font-size: 0.9em; color: #666;">å‘è¡Œè€…: ${shortIssuer}</div><div style="font-size: 0.8em; color: #999;">${new Date(tx.created_at).toLocaleString()}</div></div>`;
  } else if (tx.type === "create_account") {
    const shortAccount = safeSubstring(tx.account, 0, 8);
    txElem.innerHTML = `<div style="flex: 1;"><div style="display: flex; justify-content: space-between; align-items: center;"><span class="transaction-status status-trust">åˆ›å»ºè´¦æˆ·</span><strong>${tx.starting_balance} Pi</strong></div><div style="font-size: 0.9em; color: #666;">è´¦æˆ·: ${shortAccount}</div><div style="font-size: 0.8em; color: #999;">${new Date(tx.created_at).toLocaleString()}</div></div>`;
  } else if (tx.type === "path_payment_strict_send") {
    const sourceAsset = tx.source_asset_code ? `${tx.source_asset_code}` : 'Pi'; const destAsset = tx.asset_code ? `${tx.asset_code}` : 'Pi';
    txElem.innerHTML = `<div style="flex: 1;"><div style="display: flex; justify-content: space-between; align-items: center;"><span class="transaction-status status-outgoing">DEXå…‘æ¢</span><strong>${tx.source_amount} ${sourceAsset} -> ${tx.amount} ${destAsset}</strong></div><div style="font-size: 0.8em; color: #999;">${new Date(tx.created_at).toLocaleString()}</div></div>`;
  } else if (tx.type === "liquidity_pool_deposit") {
    txElem.innerHTML = `<div style="flex: 1;"><div style="display: flex; justify-content: space-between; align-items: center;"><span class="transaction-status status-lp-deposit">LP å­˜å…¥</span><strong>æ± å­: ${tx.pool_id || 'æœªçŸ¥'}</strong></div><div style="font-size: 0.9em; color: #666;">ä»½é¢: ${tx.shares || 'æœªçŸ¥'}</div><div style="font-size: 0.8em; color: #999;">${new Date(tx.created_at).toLocaleString()}</div></div>`;
  } else if (tx.type === "liquidity_pool_withdraw") {
    txElem.innerHTML = `<div style="flex: 1;"><div style="display: flex; justify-content: space-between; align-items: center;"><span class="transaction-status status-lp-withdraw">LP æ’¤å‡º</span><strong>æ± å­: ${tx.pool_id || 'æœªçŸ¥'}</strong></div><div style="font-size: 0.9em; color: #666;">ä»½é¢: ${tx.shares || 'æœªçŸ¥'}</div><div style="font-size: 0.8em; color: #999;">${new Date(tx.created_at).toLocaleString()}</div></div>`;
  } else { txElem.innerHTML = `<div style="flex: 1;"><div style="display: flex; justify-content: space-between; align-items: center;"><span class="transaction-status">${tx.type}</span></div><div style="font-size: 0.8em; color: #999;">${new Date(tx.created_at).toLocaleString()}</div></div>`; }
  return txElem;
}

async function refreshAccountData() {
  if (!keypair) { showMessage("è¯·å…ˆç™»å½•", 'error'); return; }
  if (isOfflineMode) { loadCachedAssets(); showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åˆ·æ–°æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜", 'error'); return; }
  toggleLoading(true);
  try {
    const account = await loadAccountSafely(publicKey);
    currentBalances = account.balances; currentAssets = getAccountAllAssets(account, publicKey);
    displayAssets(currentAssets); displayDexAssets(currentAssets);
    historyCollection = await server.transactions().forAccount(publicKey).order("desc").limit(10).call();
    const transaction_records = await processTransactions(historyCollection, publicKey);
    const transactionLog = document.getElementById("transaction-log"); transactionLog.innerHTML = "";
    if (transaction_records.length === 0) { transactionLog.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— äº¤æ˜“è®°å½•</p>'; } else { transaction_records.forEach((tx) => { if (tx && tx.created_at) { const txElem = createTransactionElement(tx); transactionLog.appendChild(txElem); } }); }
    document.getElementById("prev-history").disabled = !historyCollection.prev; document.getElementById("next-history").disabled = !historyCollection.next;
    showMessage("è´¦æˆ·æ•°æ®å·²åˆ·æ–°", 'success');
  } catch (e) {
    if (e.message.includes("ç¦»çº¿") || e.message.includes("ç½‘ç»œè¿æ¥å¤±è´¥") || e.message.includes("è´¦æˆ·ä¸å­˜åœ¨")) { loadCachedAssets(); showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šèµ„äº§æ•°æ®æš‚ä¸å¯ç”¨ï¼Œä½¿ç”¨ç¼“å­˜", 'error'); } else { showMessage(`åˆ·æ–°å¤±è´¥: ${e.message}`, 'error'); }
  } finally { toggleLoading(false); }
}

async function autoLogin() {
  const savedMnemonic = localStorage.getItem('mnemonic'), savedNetwork = localStorage.getItem('network');
  if (!savedMnemonic) return false;
  const networkSelect = document.getElementById("network-select"); networkSelect.value = savedNetwork || 'testnet'; const isTestnet = networkSelect.value === "testnet"; setNetwork(isTestnet); mnemonic = savedMnemonic;
  toggleLoading(true);
  try {
    keypair = await generateKeypairFromMnemonic(mnemonic); publicKey = keypair.publicKey();
    showMessage(`è‡ªåŠ¨ç™»å½•æˆåŠŸï¼å½“å‰ç½‘ç»œ: ${isTestnet ? 'æµ‹è¯•ç½‘' : 'ä¸»ç½‘'}`, 'success');
    document.getElementById("login-form").style.display = "none"; document.getElementById("wallet-info").style.display = "block"; document.getElementById("public-key").innerText = `åœ°å€: ${publicKey}`;
    const qrcodeContainer = document.getElementById("qrcode"); qrcodeContainer.innerHTML = ''; new QRCode(qrcodeContainer, publicKey);
    const { account } = await loadKeypairAndAccount(mnemonic);
    if (account) { currentBalances = account.balances; currentAssets = getAccountAllAssets(account, publicKey); await refreshAccountData(); } else { loadCachedAssets(); showMessage("ç™»å½•æˆåŠŸï¼è¿™æ˜¯ä¸€ä¸ªæ–°é’±åŒ…æˆ–ç½‘ç»œè¿æ¥é—®é¢˜ã€‚ç½‘ç»œæ¢å¤åå¯åˆ·æ–°èµ„äº§ã€‚", 'info'); }
    return true;
  } catch (e) { showMessage(e.message, 'error'); localStorage.removeItem('mnemonic'); localStorage.removeItem('network'); document.getElementById("wallet-info").style.display = "none"; return false; } finally { toggleLoading(false); }
}

function logout() { localStorage.removeItem('mnemonic'); localStorage.removeItem('network'); localStorage.removeItem('cachedAssets'); mnemonic = null; keypair = null; publicKey = null; currentAssets = []; document.getElementById("wallet-info").style.display = "none"; document.getElementById("login-form").style.display = "block"; showMessage("å·²æ³¨é”€", 'info'); }

function clearCache() { localStorage.removeItem('mnemonic'); localStorage.removeItem('network'); localStorage.removeItem('cachedAssets'); showMessage("ç¼“å­˜å·²æ¸…é™¤", 'success'); document.getElementById("mnemonic").value = ''; }

document.getElementById("login-form").addEventListener("submit", async function (event) { event.preventDefault(); const networkSelect = document.getElementById("network-select").value; const isTestnet = networkSelect === "testnet"; setNetwork(isTestnet); mnemonic = document.getElementById("mnemonic").value.trim(); document.getElementById("mnemonic").value = ""; if (!mnemonic) { showMessage("è¯·è¾“å…¥åŠ©è®°è¯", 'error'); return; } localStorage.setItem('mnemonic', mnemonic); localStorage.setItem('network', networkSelect); await autoLogin(); });

document.getElementById("clear-cache-btn").addEventListener("click", clearCache); document.getElementById("logout-btn").addEventListener("click", logout);

document.getElementById("show-transfer-modal-btn").addEventListener("click", function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•è½¬è´¦ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } const select = document.getElementById("asset-select"); select.innerHTML = '<option value="native">Pi (åŸç”Ÿèµ„äº§)</option>'; currentAssets.forEach((asset) => { if (!asset.is_native && !asset.is_lp) { const opt = document.createElement("option"); opt.value = `${asset.asset_code}:${asset.asset_issuer}`; opt.text = `${asset.asset_code} (${(asset.asset_issuer || '').substring(0, 8)}...)`; select.add(opt); } }); document.getElementById("transfer-modal").style.display = "flex"; });

document.getElementById("confirm-transfer-btn").addEventListener("click", async function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•è½¬è´¦ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } const selectedAsset = document.getElementById("asset-select").value, desAddr = document.getElementById("modal-des_addr").value.trim(), amount = document.getElementById("modal-amount").value, memo = document.getElementById("modal-memo").value; if (!desAddr) { showMessage("è¯·è¾“å…¥ç›®æ ‡åœ°å€", 'error'); return; } if (!amount || parseFloat(amount) <= 0) { showMessage("è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢", 'error'); return; } let asset_code = '', asset_issuer = ''; if (selectedAsset !== "native") [asset_code, asset_issuer] = selectedAsset.split(":"); document.getElementById("transfer-modal").style.display = "none"; toggleLoading(true); try { const { keypair: kp, account } = await loadKeypairAndAccount(mnemonic); if (!account) { showMessage("è´¦æˆ·ä¸å­˜åœ¨æˆ–ç½‘ç»œè¿æ¥å¤±è´¥", 'error'); return; } const asset = asset_code ? new StellarSdk.Asset(asset_code, asset_issuer) : StellarSdk.Asset.native(); const asset_display = asset.isNative() ? "Pi" : `${asset_code}:${asset_issuer.substring(0, 8)}...`; const transaction = new StellarSdk.TransactionBuilder(account, { fee: await server.fetchBaseFee(), networkPassphrase: NETWORK_PASSPHRASE }).addMemo(memo ? StellarSdk.Memo.text(memo) : StellarSdk.Memo.none()).addOperation(StellarSdk.Operation.payment({ destination: desAddr, asset: asset, amount: amount })).setTimeout(30).build(); transaction.sign(kp); const response = await server.submitTransaction(transaction); showMessage(`è½¬è´¦æˆåŠŸ - ${amount} ${asset_display}`, 'success'); document.getElementById("modal-des_addr").value = ''; document.getElementById("modal-amount").value = ''; document.getElementById("modal-memo").value = ''; setTimeout(refreshAccountData, 2000); } catch (e) { let error_msg = e.message; if (e.response?.data?.extras?.result_codes?.transaction === "tx_failed") { const op_result = e.response.data.extras.result_codes.operations[0]; if (op_result === "op_no_destination") error_msg = "ç›®æ ‡è´¦æˆ·ä¸å­˜åœ¨"; else if (op_result === "op_underfunded") error_msg = "ä½™é¢ä¸è¶³"; else if (op_result === "op_no_trust") error_msg = "ç›®æ ‡è´¦æˆ·æœªä¿¡ä»»è¯¥èµ„äº§"; else if (op_result === "op_low_reserve") error_msg = "ç›®æ ‡è´¦æˆ·ä¿¡ä»»çº¿å·²è¾¾ä¸Šé™"; else error_msg = `äº¤æ˜“å¤±è´¥: ${error_msg}`; } showMessage(error_msg, 'error'); } finally { toggleLoading(false); } });
document.getElementById("cancel-transfer-btn").addEventListener("click", function () { document.getElementById("transfer-modal").style.display = "none"; });

document.getElementById("create-asset-btn").addEventListener("click", function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åˆ›å»ºèµ„äº§ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } document.getElementById("create-asset-code").value = ''; document.getElementById("create-initial-supply").value = ''; document.getElementById("create-destination").value = ''; document.getElementById("create-modal").style.display = "flex"; });
document.getElementById("confirm-create-btn").addEventListener("click", async function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åˆ›å»ºèµ„äº§ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } const asset_code = document.getElementById("create-asset-code").value.trim().toUpperCase(), initial_supply = document.getElementById("create-initial-supply").value, destination = document.getElementById("create-destination").value.trim() || publicKey; if (!asset_code || asset_code.length < 1 || asset_code.length > 12) { showMessage("èµ„äº§ä»£ç é•¿åº¦å¿…é¡»åœ¨1-12ä¸ªå­—ç¬¦ä¹‹é—´", 'error'); return; } if (!initial_supply || parseFloat(initial_supply) <= 0) { showMessage("è¯·è¾“å…¥æœ‰æ•ˆçš„å‘è¡Œé‡", 'error'); return; } document.getElementById("create-modal").style.display = "none"; toggleLoading(true); try { const { keypair: kp, account } = await loadKeypairAndAccount(mnemonic); if (!account) { showMessage("è´¦æˆ·ä¸å­˜åœ¨æˆ–ç½‘ç»œè¿æ¥å¤±è´¥", 'error'); return; } try { await server.loadAccount(destination); } catch (e) { if (e.name === 'NotFoundError') { showMessage(`ç›®æ ‡è´¦æˆ· ${destination.substring(0,8)}... ä¸å­˜åœ¨`, 'error'); return; } throw e; } const asset = new StellarSdk.Asset(asset_code, publicKey); const transaction = new StellarSdk.TransactionBuilder(account, { fee: await server.fetchBaseFee(), networkPassphrase: NETWORK_PASSPHRASE }).addOperation(StellarSdk.Operation.payment({ destination: destination, asset: asset, amount: initial_supply })).setTimeout(30).build(); transaction.sign(kp); const response = await server.submitTransaction(transaction); const target_info = destination === publicKey ? "è‡ªå·±" : `åœ°å€ ${destination.substring(0,8)}...`; showMessage(`èµ„äº§ ${asset_code} åˆ›å»ºæˆåŠŸï¼Œå·²å‘${target_info}å‘è¡Œ ${initial_supply} ä¸ªä»£å¸`, 'success'); document.getElementById("create-asset-code").value = ''; document.getElementById("create-initial-supply").value = ''; document.getElementById("create-destination").value = ''; setTimeout(refreshAccountData, 2000); } catch (e) { let error_msg = e.message; if (e.response?.data?.extras?.result_codes?.operations?.[0] === "op_no_trust") { error_msg = "ç›®æ ‡è´¦æˆ·æœªä¿¡ä»»è¯¥èµ„äº§ï¼Œè¯·å…ˆè®©ç›®æ ‡è´¦æˆ·æ‰§è¡Œä¿¡ä»»æ“ä½œ"; } else if (e.response?.data?.extras?.result_codes?.transaction === "tx_failed") { const op_result = e.response.data.extras.result_codes.operations[0]; if (op_result === "op_no_destination") error_msg = "ç›®æ ‡è´¦æˆ·ä¸å­˜åœ¨"; else if (op_result === "op_underfunded") error_msg = "ä½™é¢ä¸è¶³"; else if (op_result === "op_no_trust") error_msg = "ç›®æ ‡è´¦æˆ·æœªä¿¡ä»»è¯¥èµ„äº§"; else if (op_result === "op_low_reserve") error_msg = "ç›®æ ‡è´¦æˆ·ä¿¡ä»»çº¿å·²è¾¾ä¸Šé™"; else error_msg = `äº¤æ˜“å¤±è´¥: ${error_msg}`; } showMessage(error_msg, 'error'); } finally { toggleLoading(false); } });
document.getElementById("cancel-create-btn").addEventListener("click", function () { document.getElementById("create-modal").style.display = "none"; });

document.getElementById("trust-asset-btn").addEventListener("click", function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•ä¿¡ä»»èµ„äº§ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } document.getElementById("trust-modal").style.display = "flex"; });
document.getElementById("add-dex-asset-btn").addEventListener("click", function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•æ·»åŠ DEXèµ„äº§ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } document.getElementById("trust-modal").style.display = "flex"; });
document.getElementById("confirm-trust-btn").addEventListener("click", async function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•ä¿¡ä»»èµ„äº§ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } const asset_code = document.getElementById("trust-asset-code").value.trim(), asset_issuer = document.getElementById("trust-asset-issuer").value.trim(), limit = document.getElementById("trust-limit").value || "922337203685.4775807"; if (!asset_code || !asset_issuer) { showMessage("è¯·è¾“å…¥èµ„äº§ä»£ç å’Œå‘è¡Œè€…åœ°å€", 'error'); return; } document.getElementById("trust-modal").style.display = "none"; toggleLoading(true); try { const { keypair: kp, account } = await loadKeypairAndAccount(mnemonic); if (!account) { showMessage("è´¦æˆ·ä¸å­˜åœ¨æˆ–ç½‘ç»œè¿æ¥å¤±è´¥", 'error'); return; } const account_data = await server.loadAccount(publicKey); const already_trusted = account_data.balances.some(b => b.asset_type !== 'native' && b.asset_code === asset_code && b.asset_issuer === asset_issuer); if (already_trusted) { showMessage(`å·²ç»ä¿¡ä»»èµ„äº§ ${asset_code}`, 'success'); document.getElementById("trust-asset-code").value = ''; document.getElementById("trust-asset-issuer").value = ''; document.getElementById("trust-limit").value = ''; setTimeout(refreshAccountData, 2000); return; } const asset = new StellarSdk.Asset(asset_code, asset_issuer); const transaction = new StellarSdk.TransactionBuilder(account, { fee: await server.fetchBaseFee(), networkPassphrase: NETWORK_PASSPHRASE }).addOperation(StellarSdk.Operation.changeTrust({ asset: asset, limit: limit })).setTimeout(30).build(); transaction.sign(kp); const response_tx = await server.submitTransaction(transaction); showMessage(`æˆåŠŸä¿¡ä»»èµ„äº§ ${asset_code}`, 'success'); document.getElementById("trust-asset-code").value = ''; document.getElementById("trust-asset-issuer").value = ''; document.getElementById("trust-limit").value = ''; setTimeout(refreshAccountData, 2000); } catch (e) { showMessage(`ä¿¡ä»»èµ„äº§å¤±è´¥: ${e.message}`, 'error'); } finally { toggleLoading(false); } });
document.getElementById("cancel-trust-btn").addEventListener("click", function () { document.getElementById("trust-modal").style.display = "none"; });

document.getElementById("create-lp-btn").addEventListener("click", function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åˆ›å»ºæµåŠ¨æ± ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } document.getElementById("lp-asset-b-code").value = ''; document.getElementById("lp-asset-b-issuer").value = ''; document.getElementById("lp-amount-a").value = ''; document.getElementById("lp-amount-b").value = ''; document.getElementById("lp-pool-fee").value = '30'; document.getElementById("lp-modal").style.display = "flex"; });
document.getElementById("confirm-lp-btn").addEventListener("click", async function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åˆ›å»ºæµåŠ¨æ± ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } const asset_b_code = document.getElementById("lp-asset-b-code").value.trim().toUpperCase(), asset_b_issuer = document.getElementById("lp-asset-b-issuer").value.trim(), amount_a = document.getElementById("lp-amount-a").value, amount_b = document.getElementById("lp-amount-b").value, pool_fee = parseInt(document.getElementById("lp-pool-fee").value); if (!asset_b_code || !asset_b_issuer) { showMessage("è¯·è¾“å…¥èµ„äº§ B çš„ä»£ç å’Œå‘è¡Œè€…åœ°å€", 'error'); return; } if (!amount_a || !amount_b || parseFloat(amount_a) <= 0 || parseFloat(amount_b) <= 0) { showMessage("è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜å…¥æ•°é‡", 'error'); return; } document.getElementById("lp-modal").style.display = "none"; toggleLoading(true); try { const { keypair: kp, account } = await loadKeypairAndAccount(mnemonic); if (!account) { showMessage("è´¦æˆ·ä¸å­˜åœ¨æˆ–ç½‘ç»œè¿æ¥å¤±è´¥", 'error'); return; } const base_fee = await server.fetchBaseFee(); const asset_a = StellarSdk.Asset.native(); const asset_b = new StellarSdk.Asset(asset_b_code, asset_b_issuer); const lp_asset = new StellarSdk.LiquidityPoolAsset(asset_a, asset_b, pool_fee); const account_data = await server.loadAccount(publicKey); const trusted_b = account_data.balances.some(b => b.asset_code === asset_b_code && b.asset_issuer === asset_b_issuer); let current_account = account; if (!trusted_b) { const tx_trust = new StellarSdk.TransactionBuilder(current_account, { fee: base_fee, networkPassphrase: NETWORK_PASSPHRASE }).addOperation(StellarSdk.Operation.changeTrust({ asset: asset_b })).setTimeout(30).build(); tx_trust.sign(kp); await server.submitTransaction(tx_trust); current_account = await server.loadAccount(publicKey); } const transaction = new StellarSdk.TransactionBuilder(current_account, { fee: base_fee, networkPassphrase: NETWORK_PASSPHRASE }).addOperation(StellarSdk.Operation.changeTrust({ asset: lp_asset })).addOperation(StellarSdk.Operation.liquidityPoolDeposit({ liquidityPoolId: lp_asset.liquidityPoolId, maxAmountA: amount_a, maxAmountB: amount_b, minPrice: "0.0000001", maxPrice: "10000000" })).setTimeout(30).build(); transaction.sign(kp); const response = await server.submitTransaction(transaction); showMessage(`æµåŠ¨æ€§æ± åˆ›å»º/å­˜å…¥æˆåŠŸ! å­˜å…¥ ${amount_a} Pi å’Œ ${amount_b} ${asset_b_code}`, 'success'); document.getElementById("lp-asset-b-code").value = ''; document.getElementById("lp-asset-b-issuer").value = ''; document.getElementById("lp-amount-a").value = ''; document.getElementById("lp-amount-b").value = ''; setTimeout(refreshAccountData, 2000); } catch (e) { let error_msg = e.message; if (e.response?.data?.extras?.result_codes?.operations) { const op_results = e.response.data.extras.result_codes.operations; if (op_results.some(r => r === "op_no_trust")) error_msg = "ç¼ºå°‘ä¿¡ä»»çº¿ï¼Œè¯·å…ˆä¿¡ä»»èµ„äº§ B"; else if (op_results.some(r => r === "op_underfunded")) error_msg = "ä½™é¢ä¸è¶³"; } showMessage(error_msg, 'error'); } finally { toggleLoading(false); } });
document.getElementById("cancel-lp-btn").addEventListener("click", function () { document.getElementById("lp-modal").style.display = "none"; });

document.getElementById("confirm-delete-btn").addEventListener("click", async function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åˆ é™¤èµ„äº§ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } if (!assetToDelete) return; document.getElementById("delete-modal").style.display = "none"; toggleLoading(true); try { const { keypair: kp, account } = await loadKeypairAndAccount(mnemonic); if (!account) { showMessage("è´¦æˆ·ä¸å­˜åœ¨æˆ–ç½‘ç»œè¿æ¥å¤±è´¥", 'error'); return; } const account_data = await server.loadAccount(publicKey); const asset_balance = account_data.balances.find(b => b.asset_code === assetToDelete.assetCode && b.asset_issuer === assetToDelete.assetIssuer); if (asset_balance && parseFloat(asset_balance.balance) > 0) { showMessage(`æ— æ³•ç§»é™¤ä¿¡ä»»ï¼Œèµ„äº§ä½™é¢ä¸ä¸º0ã€‚è¯·å…ˆå°† ${asset_balance.balance} ${assetToDelete.assetCode} è½¬å‡ºåå†å°è¯•ç§»é™¤ã€‚`, 'error'); return; } const asset = new StellarSdk.Asset(assetToDelete.assetCode, assetToDelete.assetIssuer); const transaction = new StellarSdk.TransactionBuilder(account, { fee: await server.fetchBaseFee(), networkPassphrase: NETWORK_PASSPHRASE }).addOperation(StellarSdk.Operation.changeTrust({ asset: asset, limit: "0" })).setTimeout(30).build(); transaction.sign(kp); const response_tx = await server.submitTransaction(transaction); showMessage(`æˆåŠŸç§»é™¤èµ„äº§ ${assetToDelete.assetCode} çš„ä¿¡ä»»`, 'success'); assetToDelete = null; setTimeout(refreshAccountData, 2000); } catch (e) { showMessage(`ç§»é™¤èµ„äº§ä¿¡ä»»å¤±è´¥: ${e.message}`, 'error'); } finally { toggleLoading(false); } });
document.getElementById("cancel-delete-btn").addEventListener("click", function () { document.getElementById("delete-modal").style.display = "none"; assetToDelete = null; });

document.getElementById("get-quote-btn").addEventListener("click", async function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•è·å–æŠ¥ä»·ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } const sourceAmount = document.getElementById("swap-source-amount").value; if (!sourceAmount || parseFloat(sourceAmount) <= 0) { showMessage("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡", 'error'); return; } toggleLoading(true); try { let path_url; if (isReverseSwap) { path_url = `${HORIZON_URL}/paths/strict-send?source_asset_type=credit_alphanum12&source_asset_code=${swapSource.code}&source_asset_issuer=${swapSource.issuer}&source_amount=${sourceAmount}&destination_assets=native`; } else { path_url = `${HORIZON_URL}/paths/strict-send?source_asset_type=native&source_amount=${sourceAmount}&destination_assets=${swapTarget.code}%3A${swapTarget.issuer}`; } const resp = await fetch(path_url).then(r => r.json()); if (!resp._embedded || !resp._embedded.records || resp._embedded.records.length === 0) throw new Error("æœªæ‰¾åˆ°å¯ç”¨å…‘æ¢è·¯å¾„ï¼Œå¯èƒ½æµåŠ¨æ€§ä¸è¶³ã€‚"); const record = resp._embedded.records[0]; const targetAsset = isReverseSwap ? "Pi" : swapTarget.code; document.getElementById("swap-estimate-amount").textContent = `${record.destination_amount} ${targetAsset}`; } catch (e) { showMessage(e.message, 'error'); } finally { toggleLoading(false); } });

document.getElementById("confirm-swap-btn").addEventListener("click", async function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•å…‘æ¢ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } const sourceAmount = document.getElementById("swap-source-amount").value, slippage = document.getElementById("slippage-select").value; if (!sourceAmount || parseFloat(sourceAmount) <= 0) { showMessage("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡", 'error'); return; } document.getElementById("swap-modal").style.display = "none"; toggleLoading(true); try { const { keypair: kp, account } = await loadKeypairAndAccount(mnemonic); if (!account) { showMessage("è´¦æˆ·ä¸å­˜åœ¨æˆ–ç½‘ç»œè¿æ¥å¤±è´¥", 'error'); return; } let path_url, dest_amount, path; if (isReverseSwap) { const source_asset = new StellarSdk.Asset(swapSource.code, swapSource.issuer); const dest_asset = StellarSdk.Asset.native(); path_url = `${HORIZON_URL}/paths/strict-send?source_asset_type=credit_alphanum12&source_asset_code=${swapSource.code}&source_asset_issuer=${swapSource.issuer}&source_amount=${sourceAmount}&destination_assets=native`; const resp = await fetch(path_url).then(r => r.json()); if (!resp._embedded || !resp._embedded.records.length) throw new Error("æœªæ‰¾åˆ°å¯ç”¨å…‘æ¢è·¯å¾„ï¼Œå¯èƒ½æµåŠ¨æ€§ä¸è¶³ã€‚"); const record = resp._embedded.records[0]; dest_amount = record.destination_amount; path = (record.path || []).map(p => p.asset_type === "native" ? StellarSdk.Asset.native() : new StellarSdk.Asset(p.asset_code, p.asset_issuer)); } else { const destination_asset = new StellarSdk.Asset(swapTarget.code, swapTarget.issuer); path_url = `${HORIZON_URL}/paths/strict-send?source_asset_type=native&source_amount=${sourceAmount}&destination_assets=${swapTarget.code}%3A${swapTarget.issuer}`; const resp = await fetch(path_url).then(r => r.json()); if (!resp._embedded || !resp._embedded.records.length) throw new Error("æœªæ‰¾åˆ°å¯ç”¨å…‘æ¢è·¯å¾„ï¼Œå¯èƒ½æµåŠ¨æ€§ä¸è¶³ã€‚"); const record = resp._embedded.records[0]; dest_amount = record.destination_amount; path = (record.path || []).map(p => p.asset_type === "native" ? StellarSdk.Asset.native() : new StellarSdk.Asset(p.asset_code, p.asset_issuer)); } const dest_min_value = parseFloat(dest_amount) * (1 - parseFloat(slippage) / 100); const dest_min_str = dest_min_value.toFixed(7); let send_asset, dest_asset; if (isReverseSwap) { send_asset = new StellarSdk.Asset(swapSource.code, swapSource.issuer); dest_asset = StellarSdk.Asset.native(); } else { send_asset = StellarSdk.Asset.native(); dest_asset = new StellarSdk.Asset(swapTarget.code, swapTarget.issuer); } const transaction = new StellarSdk.TransactionBuilder(account, { fee: await server.fetchBaseFee(), networkPassphrase: NETWORK_PASSPHRASE }).addOperation(StellarSdk.Operation.pathPaymentStrictSend({ sendAsset: send_asset, sendAmount: sourceAmount, destination: publicKey, destAsset: dest_asset, destMin: dest_min_str, path: path })).setTimeout(60).build(); transaction.sign(kp); const response = await server.submitTransaction(transaction); const targetAsset = isReverseSwap ? "Pi" : swapTarget.code; const sourceAsset = isReverseSwap ? swapSource.code : "Pi"; showMessage(`å…‘æ¢æˆåŠŸ: ${sourceAmount} ${sourceAsset} -> ${dest_amount} ${targetAsset}`, 'success'); setTimeout(refreshAccountData, 2000); } catch (e) { let error_msg = e.message; if (e.response?.data?.extras?.result_codes?.transaction === "tx_failed") { error_msg = `äº¤æ˜“æäº¤å¤±è´¥: ${error_msg}`; } showMessage(error_msg, 'error'); } finally { toggleLoading(false); } });
document.getElementById("cancel-swap-btn").addEventListener("click", function () { document.getElementById("swap-modal").style.display = "none"; });

document.getElementById("export-mnemonic-btn").addEventListener("click", function () { document.getElementById("export-mnemonic-text").value = mnemonic; document.getElementById("export-modal").style.display = "flex"; });
document.getElementById("close-export-btn").addEventListener("click", function () { document.getElementById("export-modal").style.display = "none"; document.getElementById("export-mnemonic-text").value = ""; });
document.getElementById("copy-mnemonic-btn").addEventListener("click", function () { const textArea = document.getElementById("export-mnemonic-text"); textArea.select(); document.execCommand("copy"); showMessage("åŠ©è®°è¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", 'success'); setTimeout(() => { if (navigator.clipboard) navigator.clipboard.writeText(''); }, 3000); });

document.getElementById("refresh-btn").addEventListener("click", refreshAccountData); document.getElementById("refresh-assets-btn").addEventListener("click", refreshAccountData);

const tabs = document.querySelectorAll(".tab"); tabs.forEach((tab) => { tab.addEventListener("click", function () { tabs.forEach((t) => t.classList.remove("active")); tab.classList.add("active"); document.querySelectorAll(".history, .migrations").forEach((content) => { content.style.display = "none"; }); document.getElementById(tab.dataset.tab).style.display = "block"; }); });

document.getElementById("show-qrcode-btn").addEventListener("click", function () { const qrcodeContainer = document.getElementById("qrcode-container"); qrcodeContainer.style.display = qrcodeContainer.style.display === "none" ? "block" : "none"; });

document.getElementById("prev-history").addEventListener("click", async function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åŠ è½½å†å²ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } if (!historyCollection.prev) return; toggleLoading(true); try { historyCollection = await historyCollection.prev(); const transaction_records = await processTransactions(historyCollection, publicKey); const transactionLog = document.getElementById("transaction-log"); transactionLog.innerHTML = ""; transaction_records.forEach((tx) => { if (tx && tx.created_at) { const txElem = createTransactionElement(tx); transactionLog.appendChild(txElem); } }); document.getElementById("prev-history").disabled = !historyCollection.prev; document.getElementById("next-history").disabled = !historyCollection.next; } catch (e) { showMessage("åŠ è½½å¤±è´¥: " + e.message, 'error'); } finally { toggleLoading(false); } });
document.getElementById("next-history").addEventListener("click", async function () { if (isOfflineMode) { showMessage("â›” ç¦»çº¿æ¨¡å¼ï¼šæ— æ³•åŠ è½½å†å²ï¼Œè¯·è¿æ¥ç½‘ç»œ", 'error'); return; } if (!historyCollection.next) return; toggleLoading(true); try { historyCollection = await historyCollection.next(); const transaction_records = await processTransactions(historyCollection, publicKey); const transactionLog = document.getElementById("transaction-log"); transactionLog.innerHTML = ""; transaction_records.forEach((tx) => { if (tx && tx.created_at) { const txElem = createTransactionElement(tx); transactionLog.appendChild(txElem); } }); document.getElementById("prev-history").disabled = !historyCollection.prev; document.getElementById("next-history").disabled = !historyCollection.next; } catch (e) { showMessage("åŠ è½½å¤±è´¥: " + e.message, 'error'); } finally { toggleLoading(false); } });

document.addEventListener('DOMContentLoaded', async function() {
  const hasAgreed = localStorage.getItem('disclaimerAgreed');
  if (!hasAgreed) { document.getElementById("disclaimer-modal").style.display = "flex"; } else { document.getElementById("disclaimer-modal").style.display = "none"; }
  document.getElementById("agree-btn").addEventListener("click", function() { localStorage.setItem('disclaimerAgreed', 'true'); document.getElementById("disclaimer-modal").style.display = "none"; initApp(); });
  document.getElementById("disagree-btn").addEventListener("click", function() { alert("æ‚¨å·²é€‰æ‹©ä¸åŒæ„ï¼Œé¡µé¢å°†å…³é—­ã€‚"); window.close(); });
  async function initApp() { const loggedIn = await autoLogin(); if (!loggedIn) { checkNetwork(); } else { checkNetwork(true); } window.addEventListener('online', () => checkNetwork(true)); window.addEventListener('offline', () => updateNetworkStatus(false)); }
  initApp();
    // æ·»åŠ åˆ›å»ºé’±åŒ…æŒ‰é’®äº‹ä»¶
  document.getElementById("create-wallet-btn").addEventListener("click", function () {
    window.location.href = "create_wallet.html";
  });
});
</script>
</body>
</html>