<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>创建 Pi Network 钱包</title>
<style>
* { 
  box-sizing: border-box; 
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', 'Microsoft YaHei', 'Helvetica Neue', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
  background-attachment: fixed;
  margin: 0; 
  padding: 20px 0;
  display: flex; 
  justify-content: center; 
  align-items: flex-start;
  min-height: 100vh;
  overflow-y: auto;
}

.container {
  max-width: 900px; 
  width: 95%;
  background: rgba(255, 255, 255, 0.98);
  padding: 35px 30px;
  box-shadow: 0 15px 60px rgba(0, 0, 0, 0.3);
  border-radius: 25px;
  position: relative;
  animation: fadeInUp 0.6s ease;
  margin: 20px auto;
}

@keyframes fadeInUp {
  from { 
    opacity: 0; 
    transform: translateY(30px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

h1 { 
  text-align: center; 
  background: linear-gradient(135deg, #6a1b9a, #8e24aa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: bold; 
  font-size: 2.2em; 
  margin-bottom: 15px;
}

h2 { 
  text-align: center; 
  color: #444; 
  font-size: 1.3em;
  margin: 25px 0 15px;
  font-weight: 600;
}

h3 {
  color: #6a1b9a;
  font-size: 1.4em;
  margin: 30px 0 15px;
  text-align: center;
  font-weight: 600;
}

textarea, input[type="text"] {
  width: 100%; 
  padding: 14px; 
  border-radius: 12px; 
  border: 2px solid #e0e0e0;
  font-size: 15px; 
  margin: 8px 0 16px; 
  transition: all 0.3s ease; 
  resize: none;
  background: #fafafa;
  font-family: 'Courier New', monospace;
}

textarea:focus, input[type="text"]:focus { 
  border-color: #8e24aa; 
  box-shadow: 0 0 0 3px rgba(142, 36, 170, 0.1); 
  outline: none;
  background: #fff;
}

button {
  display: block; 
  width: 100%; 
  padding: 14px; 
  font-size: 16px; 
  font-weight: 600;
  color: white; 
  border: none; 
  border-radius: 12px; 
  margin-top: 12px;
  cursor: pointer; 
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

button:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

button:active {
  transform: translateY(-1px);
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

#copy-mnemonic-btn, 
#copy-private-key-btn { 
  background: linear-gradient(135deg, #6a1b9a, #8e24aa); 
}

#copy-public-key-btn { 
  background: linear-gradient(135deg, #007bff, #00bfff); 
}

#onchain-btn { 
  background: linear-gradient(135deg, #ff9800, #ff5722); 
  box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4); 
}

#custom-onchain-btn {
  background: linear-gradient(135deg, #28a745, #20c997);
  box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

#return-btn { 
  background: linear-gradient(135deg, #757575, #b0bec5); 
}

.form-note {
  color: #666;
  font-size: 0.95em;
  text-align: center;
  margin: 15px 0;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 10px;
}

.form-note.warning { 
  color: #e74c3c; 
  font-weight: 600; 
  background: rgba(255, 235, 238, 0.8); 
  border-left: 4px solid #e74c3c;
}

.form-note.info {
  color: #0c5460;
  background: #d1ecf1;
  border-left: 4px solid #0c5460;
}

.message { 
  text-align: center; 
  margin: 18px 0; 
  padding: 16px; 
  border-radius: 12px; 
  display: none; 
  font-size: 1.05em;
  font-weight: 500;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.success { 
  background: #e6ffed; 
  color: #2e7d32; 
  border: 2px solid #c8e6c9; 
}

.error { 
  background: #ffebee; 
  color: #c62828; 
  border: 2px solid #ef9a9a; 
}

/* 梅花加载动画优化 */
.loader-overlay {
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%;
  background: rgba(255, 255, 255, 0.95); 
  backdrop-filter: blur(10px);
  z-index: 999; 
  justify-content: center; 
  align-items: center; 
  flex-direction: column;
}

.plum { 
  width: 90px; 
  height: 90px; 
  position: relative; 
  animation: spin 1.8s ease-in-out infinite; 
}

.plum div { 
  width: 28px; 
  height: 28px; 
  background: radial-gradient(circle, #ff9800 40%, #f57c00 80%); 
  border-radius: 50%; 
  position: absolute; 
  top: 0; 
  left: 0;
  box-shadow: 0 2px 8px rgba(255, 152, 0, 0.4);
}

.plum div:nth-child(1) { transform: rotate(0deg) translateX(40px); }
.plum div:nth-child(2) { transform: rotate(72deg) translateX(40px); }
.plum div:nth-child(3) { transform: rotate(144deg) translateX(40px); }
.plum div:nth-child(4) { transform: rotate(216deg) translateX(40px); }
.plum div:nth-child(5) { transform: rotate(288deg) translateX(40px); }

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loader-text { 
  margin-top: 20px; 
  font-size: 1.3em; 
  color: #6a1b9a; 
  font-weight: bold; 
}

/* 成功/失败弹窗优化 */
.popup { 
  display: none; 
  position: fixed; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%) scale(0.8); 
  background: white; 
  border-radius: 25px; 
  padding: 35px; 
  box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4); 
  text-align: center; 
  z-index: 1000; 
  opacity: 0; 
  transition: all 0.3s ease;
  max-width: 500px;
  width: 90%;
}

.popup.show { 
  display: block; 
  transform: translate(-50%, -50%) scale(1); 
  opacity: 1; 
}

.popup h3 { 
  color: #6a1b9a; 
  margin-bottom: 15px;
  font-size: 1.6em;
}

.popup p { 
  color: #555; 
  margin-bottom: 25px;
  font-size: 1.1em;
  line-height: 1.6;
}

.popup button { 
  background: linear-gradient(135deg, #ff9800, #ff5722); 
  box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4); 
}

.popup.error-popup h3 { 
  color: #c62828; 
}

.popup.error-popup button {
  background: linear-gradient(135deg, #dc3545, #c82333);
}

/* 分隔线 */
.divider {
  height: 2px;
  background: linear-gradient(90deg, transparent, #e0e0e0, transparent);
  margin: 30px 0;
}

/* 自定义上链区域样式 */
.custom-onchain-section {
  background: linear-gradient(135deg, rgba(40, 167, 69, 0.05), rgba(32, 201, 151, 0.05));
  padding: 25px;
  border-radius: 15px;
  border: 2px dashed #28a745;
  margin-top: 30px;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .container {
    padding: 25px 20px;
    border-radius: 20px;
  }
  
  h1 {
    font-size: 1.8em;
  }
  
  h2 {
    font-size: 1.1em;
  }
  
  h3 {
    font-size: 1.2em;
  }
  
  button {
    padding: 12px;
    font-size: 15px;
  }
  
  .popup {
    padding: 25px;
  }
}

@media (max-width: 480px) {
  h1 {
    font-size: 1.5em;
  }
  
  .plum {
    width: 70px;
    height: 70px;
  }
  
  .plum div {
    width: 22px;
    height: 22px;
  }
  
  .plum div:nth-child(1) { transform: rotate(0deg) translateX(30px); }
  .plum div:nth-child(2) { transform: rotate(72deg) translateX(30px); }
  .plum div:nth-child(3) { transform: rotate(144deg) translateX(30px); }
  .plum div:nth-child(4) { transform: rotate(216deg) translateX(30px); }
  .plum div:nth-child(5) { transform: rotate(288deg) translateX(30px); }
}
</style>
</head>

<body>
  <!-- 梅花加载动画 -->
  <div class="loader-overlay" id="loader">
    <div class="plum">
      <div></div><div></div><div></div><div></div><div></div>
    </div>
    <div class="loader-text">钱包上链中,请稍候...</div>
  </div>

  <!-- 成功弹窗 -->
  <div class="popup" id="success-popup">
    <h3>✅ 钱包上链成功!</h3>
    <p>您的钱包已成功上链,现在可以登录使用。</p>
    <button onclick="closePopup('success-popup')">我知道了</button>
  </div>

  <!-- 失败弹窗 -->
  <div class="popup error-popup" id="fail-popup">
    <h3>❌ 钱包上链失败!</h3>
    <p id="fail-msg">请稍后重试或检查网络。</p>
    <button onclick="closePopup('fail-popup')">我知道了</button>
  </div>

  <div class="container">
    <h1>🪙 创建 Pi Network 钱包</h1>
    
    <div id="wallet-info">
      <h2>您的助记词 (24个单词)</h2>
      <textarea id="mnemonic-display" rows="4" readonly></textarea>
      <button id="copy-mnemonic-btn">📋 复制助记词</button>

      <h2>您的私钥</h2>
      <textarea id="private-key-display" rows="2" readonly></textarea>
      <button id="copy-private-key-btn">📋 复制私钥</button>

      <h2>您的公钥</h2>
      <textarea id="public-key-display" rows="2" readonly></textarea>
      <button id="copy-public-key-btn">📋 复制公钥</button>

      <p class="form-note warning">⚠️ 请立即保存助记词、私钥和公钥!关闭页面后将无法找回。</p>

      <button id="onchain-btn">🚀 钱包上链</button>
      <button id="return-btn">🔙 返回首页登录</button>
    </div>

    <div class="divider"></div>

    <!-- 自定义钱包上链功能 -->
    <div class="custom-onchain-section">
      <h3>🔑 自定义钱包上链</h3>
      <p class="form-note info">💡 如果您已有钱包公钥,可以在此处输入进行上链操作</p>
      
      <label for="custom-public-key" style="display: block; font-weight: 600; color: #555; margin-bottom: 8px;">
        输入自定义公钥
      </label>
      <input 
        type="text" 
        id="custom-public-key" 
        placeholder="例如: GXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
        maxlength="56"
      />
      
      <p class="form-note warning">⚠️ 请确保输入的公钥格式正确(以G开头,56个字符)</p>
      
      <button id="custom-onchain-btn">🚀 提交自定义钱包上链</button>
    </div>

    <div id="message" class="message"></div>
  </div>

<script src="libs/deps.min.js"></script>
<script src="stellar-sdk.min.js"></script>
<script>
const backendUrl = "http://43.154.98.43:5000/onchain";

function showLoader(show=true) { 
  document.getElementById("loader").style.display = show ? "flex" : "none"; 
}

function showPopup(id='success-popup') { 
  document.getElementById(id).classList.add("show"); 
}

function closePopup(id) { 
  document.getElementById(id).classList.remove("show"); 
}

function showMessage(msg, type='info') {
  const m = document.getElementById("message");
  m.textContent = msg;
  m.className = `message ${type}`;
  m.style.display = "block";
  setTimeout(() => m.style.display = "none", 5000);
}

function copyToClipboard(text) { 
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text)
      .then(() => showMessage("已复制到剪贴板", "success"))
      .catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed";
  textArea.style.left = "-999999px";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    document.execCommand('copy');
    showMessage("已复制到剪贴板", "success");
  } catch (err) {
    showMessage("复制失败,请手动复制", "error");
  }
  document.body.removeChild(textArea);
}

function generateWallet() {
  const mnemonic = bip39.generateMnemonic(256);
  const seed = bip39.mnemonicToSeedSync(mnemonic);
  const derived = ed25519.derivePath("m/44'/314159'/0'", seed);
  const keypair = StellarSdk.Keypair.fromRawEd25519Seed(derived.key);
  
  document.getElementById("mnemonic-display").value = mnemonic;
  document.getElementById("private-key-display").value = keypair.secret();
  document.getElementById("public-key-display").value = keypair.publicKey();
}

// 验证Stellar公钥格式
function isValidStellarPublicKey(publicKey) {
  if (!publicKey || typeof publicKey !== 'string') return false;
  if (publicKey.length !== 56) return false;
  if (!publicKey.startsWith('G')) return false;
  
  try {
    StellarSdk.Keypair.fromPublicKey(publicKey);
    return true;
  } catch (e) {
    return false;
  }
}

// 通用上链函数
async function performOnChain(pubKey, isCustom = false) {
  if (!pubKey) {
    showMessage("未生成公钥", "error");
    return;
  }

  // 验证公钥格式
  if (!isValidStellarPublicKey(pubKey)) {
    showMessage("公钥格式不正确,请检查后重试", "error");
    return;
  }

  showLoader(true);
  try {
    const res = await fetch(backendUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ public_key: pubKey })
    });
    
    const data = await res.json();
    showLoader(false);

    if (data.status === "success") {
      showPopup('success-popup');
      
      // 禁用对应的上链按钮
      if (isCustom) {
        const btn = document.getElementById("custom-onchain-btn");
        btn.disabled = true;
        btn.textContent = "已上链 ✅";
        // 清空输入框
        document.getElementById("custom-public-key").value = "";
      } else {
        const btn = document.getElementById("onchain-btn");
        btn.disabled = true;
        btn.textContent = "已上链 ✅";
      }
    } else {
      document.getElementById("fail-msg").textContent = data.message || "请稍后重试或检查网络。";
      showPopup('fail-popup');
    }
  } catch (err) {
    showLoader(false);
    document.getElementById("fail-msg").textContent = "网络错误: " + err.message;
    showPopup('fail-popup');
  }
}

// 新钱包上链
async function onChain() {
  const pubKey = document.getElementById("public-key-display").value;
  await performOnChain(pubKey, false);
}

// 自定义钱包上链
async function customOnChain() {
  const pubKey = document.getElementById("custom-public-key").value.trim();
  
  if (!pubKey) {
    showMessage("请输入公钥", "error");
    return;
  }
  
  await performOnChain(pubKey, true);
}

document.addEventListener("DOMContentLoaded", () => {
  // 生成新钱包
  generateWallet();
  
  // 绑定复制按钮
  document.getElementById("copy-mnemonic-btn").onclick = () => 
    copyToClipboard(document.getElementById("mnemonic-display").value);
  
  document.getElementById("copy-private-key-btn").onclick = () => 
    copyToClipboard(document.getElementById("private-key-display").value);
  
  document.getElementById("copy-public-key-btn").onclick = () => 
    copyToClipboard(document.getElementById("public-key-display").value);
  
  // 绑定上链按钮
  document.getElementById("onchain-btn").onclick = onChain;
  document.getElementById("custom-onchain-btn").onclick = customOnChain;
  
  // 返回首页
  document.getElementById("return-btn").onclick = () => 
    window.location.href = "index.html";
  
  // 自定义公钥输入框实时验证
  const customInput = document.getElementById("custom-public-key");
  customInput.addEventListener("input", (e) => {
    const value = e.target.value.trim();
    if (value && !isValidStellarPublicKey(value)) {
      customInput.style.borderColor = "#e74c3c";
    } else if (value) {
      customInput.style.borderColor = "#28a745";
    } else {
      customInput.style.borderColor = "#e0e0e0";
    }
  });
});
</script>
</body>
</html>

